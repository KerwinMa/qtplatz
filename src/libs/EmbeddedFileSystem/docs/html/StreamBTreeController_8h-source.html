<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>EmbeddedFileSystem: StreamBTreeController.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<h1>StreamBTreeController.h</h1><div class="fragment"><pre>00001 
00002 
00003 
00004 
00005 
00006 
00007 
00008 
00009 <span class="preprocessor">#ifndef __StreamBTreeController_h__</span>
00010 <span class="preprocessor"></span><span class="preprocessor">#define __StreamBTreeController_h__</span>
00011 <span class="preprocessor"></span>
00012 <span class="preprocessor">#include &lt;set&gt;</span>
00013 <span class="preprocessor">#include &lt;QSet&gt;</span>
00014 <span class="preprocessor">#include &lt;QMap&gt;</span>
00015 <span class="preprocessor">#include &lt;map&gt;</span>
00016 
00017 <span class="preprocessor">#include "BTreeNode.h"</span>
00018 <span class="preprocessor">#include "JStream.h"</span>
00019 <span class="preprocessor">#include "JBufferedOutputStream.h"</span>
00020 <span class="preprocessor">#include "JBufferedInputStream.h"</span>
00021 
00022 <span class="keyword">const</span> <span class="keywordtype">int</span> constRemovedAddr = <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> )*2;
00023 
00027 
00028 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00029"></a><a class="code" href="classStreamBTreeController.html">00029</a> <span class="keyword">class </span><a class="code" href="classStreamBTreeController.html">StreamBTreeController</a>
00030 {
00031 <span class="keyword">public</span>:
00032 
00033         <span class="keyword">typedef</span> <a class="code" href="classBTreeNode.html">BTreeNode&lt; NodeSize, KeyT, DataT &gt;</a> <a class="code" href="classBTreeNode.html">NodeType</a>;
00034 
00035         <span class="keyword">struct </span>CacheData
00036         {
00037                 CacheData():
00038                 node( 0 )
00039                 {}
00040 
00041                 CacheData( time_t lastAccess ):
00042                 node( 0 )
00043                 {}
00044 
00045                 CacheData( <a class="code" href="classBTreeNode.html">NodeType</a> *innode ):
00046                 node( innode )
00047                 {}
00048 
00049                 <a class="code" href="classBTreeNode.html">NodeType</a> *node;
00050         };
00051 
00052         <span class="keyword">typedef</span> std::set&lt; int &gt; FreeChunksSet;
00053         <span class="keyword">typedef</span> QMap&lt; int, CacheData &gt; ChunkCacheMap;
00054 
00055         <a class="code" href="classStreamBTreeController.html">StreamBTreeController</a>();
00056 
00059         <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a1">open</a>( JStream *stor, guint maxCacheSize, JStream *journal = 0 );
00060 
00063         <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a2">isOpen</a>();
00064 
00067         <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a3">flushChanges</a>();
00068 
00071         <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a4">releaseCache</a>();
00072 
00075         <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a5">clearCache</a>();
00076 
00079         <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a6">releaseNode</a>( <span class="keywordtype">int</span> addr );
00080 
00083         guint <a class="code" href="classStreamBTreeController.html#a7">cacheSize</a>() <span class="keyword">const</span>;
00084 
00087         <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a8">setMaxCacheSize</a>( guint maxSize );
00088 
00091         guint <a class="code" href="classStreamBTreeController.html#a9">getMaxCacheSize</a>();
00092 
00095         <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a10">nodeInCache</a>( <span class="keywordtype">int</span> addr );
00096 
00099         JStream *<a class="code" href="classStreamBTreeController.html#a11">storage</a>();
00100 
00103         <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a12">clear</a>();
00104 
00107         <span class="keyword">typename</span> <a class="code" href="classBTreeNode.html">NodeType</a>* <a class="code" href="classStreamBTreeController.html#a13">root</a>();
00108 
00111         <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a14">loadNode</a>( <a class="code" href="classBTreeNode.html">NodeType</a> **node, <span class="keywordtype">int</span> addr );
00112 
00113 <span class="keyword">protected</span>:
00114 
00115         <span class="comment">// Storage related operations</span>
00116         <a class="code" href="classBTreeNode.html">NodeType</a>* newNode();
00117         <span class="keywordtype">bool</span> allocFreeSpace();
00118         <span class="keywordtype">bool</span> readAllOffsets( <a class="code" href="classBTreeNode.html">NodeType</a> *node );
00119         <span class="keywordtype">void</span> deleteNode( <a class="code" href="classBTreeNode.html">NodeType</a> *node );
00120         <span class="keywordtype">void</span> saveNode( <a class="code" href="classBTreeNode.html">NodeType</a> *node );
00121         <span class="keywordtype">int</span> rootAddr();
00122         <span class="keywordtype">void</span> rootAddr( <span class="keywordtype">int</span> addr );
00123 
00124         <span class="keywordtype">bool</span> checkJournal();
00125 
00126         <span class="keywordtype">void</span> closeController();
00127 
00128         <span class="comment">// Data</span>
00129         <a class="code" href="classBTreeNode.html">NodeType</a> *root_;
00130         JStream *storage_;
00131         JStream *journal_;
00132 
00133         FreeChunksSet freeChunks_;
00134         ChunkCacheMap cache_;
00135         guint maxCacheSize_;
00136         guint rootAddr_;
00137 };
00138 
00139 <span class="comment">//      ===================================================================</span>
00140 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::StreamBTreeController</span>
00141 
00142 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00143 <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::StreamBTreeController</a>() : 
00144 root_( 0 ),
00145 storage_( 0 ),
00146 journal_( 0 ),
00147 maxCacheSize_( 0 ),
00148 rootAddr_( 0 )
00149 {}
00150 
00151 <span class="comment">//      ===================================================================</span>
00152 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::open</span>
00153 
00154 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00155"></a><a class="code" href="classStreamBTreeController.html#a1">00155</a> <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a1">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::open</a>( JStream *stor, 
00156                                                                 guint maxCacheSize, JStream *journal )
00157 {
00158         <span class="keywordflow">if</span> ( storage_ )
00159         {
00160                 <a class="code" href="classStreamBTreeController.html#a5">clearCache</a>();
00161                 <span class="keyword">delete</span> root_;
00162                 root_ = 0;
00163                 closeController();
00164         }
00165 
00166         storage_ = stor;
00167         journal_ = journal;
00168         maxCacheSize_ = maxCacheSize;
00169 
00170         <span class="keywordtype">int</span> sig = 0x77377377;
00171 
00172         <span class="keywordflow">if</span> ( !checkJournal() )
00173         {
00174                 <span class="keywordtype">int</span> addr = rootAddr();
00175                 <span class="keywordflow">if</span> ( addr )
00176                 {
00177                         <span class="keywordflow">if</span> ( !<a class="code" href="classStreamBTreeController.html#a14">loadNode</a>( &amp;root_, addr ) )
00178                         {
00179                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00180                         }
00181                 }
00182 
00183                 <span class="keywordflow">if</span> ( !allocFreeSpace() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00184         }
00185 
00186         <span class="keywordflow">if</span> ( 0 == storage_-&gt;size() )
00187         {
00188                 storage_-&gt;write( ( <span class="keywordtype">char</span>* ) &amp;sig, <span class="keyword">sizeof</span>( sig ) );
00189                 sig = 0;
00190 
00191                 <span class="comment">// Root addr</span>
00192                 storage_-&gt;write( ( <span class="keywordtype">char</span>* ) &amp;sig, <span class="keyword">sizeof</span>( sig ) );
00193                 <span class="comment">// Removed addr</span>
00194                 storage_-&gt;write( ( <span class="keywordtype">char</span>* ) &amp;sig, <span class="keyword">sizeof</span>( sig ) );
00195         }
00196         <span class="keywordflow">else</span>
00197         {
00198                 storage_-&gt;seek( 0 );
00199                 <span class="keywordtype">int</span> fileSig = 0;
00200                 storage_-&gt;read( ( <span class="keywordtype">char</span>* ) &amp;fileSig, <span class="keyword">sizeof</span>( fileSig ) );
00201 
00202                 <span class="keywordflow">if</span> ( sig != fileSig )
00203                 {
00204                         storage_-&gt;close();
00205                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00206                 }
00207 
00208                 <span class="comment">// Load removed nodes</span>
00209                 guint removedListAddr = 0;
00210                 storage_-&gt;seek( constRemovedAddr );
00211                 <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>( removedListAddr ) != storage_-&gt;read( 
00212                         ( <span class="keywordtype">char</span>* ) &amp;removedListAddr, <span class="keyword">sizeof</span>( removedListAddr ) ) )
00213                 {
00214                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00215                 }
00216 
00217                 <span class="keywordflow">if</span> ( removedListAddr )
00218                 {
00219                         <span class="keywordflow">if</span> ( removedListAddr &gt; storage_-&gt;size() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00220                         guint rlSize = storage_-&gt;size() - removedListAddr;
00221                         <span class="keywordflow">if</span> ( rlSize )
00222                         {
00223                                 storage_-&gt;seek( removedListAddr );
00224                                 QByteArray rblock;
00225                                 rblock.resize( rlSize );
00226                                 storage_-&gt;read( rblock.data(), rlSize );
00227 
00228                                 guint curAddr = 0;
00229                                 <span class="keywordflow">for</span> ( guint i = 0; i &lt; rlSize/<span class="keyword">sizeof</span>( guint ); i++ )
00230                                 {
00231                                         ::memcpy( ( <span class="keywordtype">char</span>* ) &amp;curAddr, rblock.data() + <span class="keyword">sizeof</span>( guint )*i,
00232                                                 <span class="keyword">sizeof</span>( curAddr ) );
00233 
00234                                         freeChunks_.insert( curAddr );
00235                                 }
00236 
00237                                 storage_-&gt;resize( removedListAddr );
00238                         }
00239                 }
00240 
00241                 <span class="keywordtype">int</span> addr = rootAddr();
00242                 <span class="keywordflow">if</span> ( addr )
00243                 {
00244                         <span class="keywordflow">if</span> ( !<a class="code" href="classStreamBTreeController.html#a14">loadNode</a>( &amp;root_, addr ) )
00245                         {
00246                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00247                         }
00248                 }
00249         }
00250 
00251         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00252 }
00253 
00254 <span class="comment">//      ===================================================================</span>
00255 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::checkJournal</span>
00256 
00257 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00258 <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::checkJournal</a>()
00259 {
00260         <span class="keywordflow">if</span> ( !journal_ || 0 == journal_-&gt;size() ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00261 
00262         JBufferedInputStream&lt; JStream &gt; journal( journal_ );
00263         journal.seek( 0 );
00264 
00265         guint label = 0;
00266         <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>( label ) != 
00267                 journal.read( ( <span class="keywordtype">char</span>* ) &amp;label, <span class="keyword">sizeof</span>( label ) ) )
00268         {
00269                 journal.setSource( 0 );
00270                 journal_-&gt;resize( 0 );
00271                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00272         }
00273 
00274         <span class="keywordflow">if</span> ( ~0 != label )
00275         {
00276                 journal.setSource( 0 );
00277                 journal_-&gt;resize( 0 );
00278                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00279         }
00280 
00281         <span class="comment">// Root</span>
00282         label = 0;
00283         <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>( label ) != 
00284                 journal.read( ( <span class="keywordtype">char</span>* ) &amp;label, <span class="keyword">sizeof</span>( label ) ) )
00285         {
00286                 journal.setSource( 0 );
00287                 journal_-&gt;resize( 0 );
00288                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00289         }
00290 
00291         <span class="keywordflow">if</span> ( label )
00292         {
00293                 storage_-&gt;seek( <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );
00294                 storage_-&gt;write( ( <span class="keywordtype">char</span>* ) &amp;label, <span class="keyword">sizeof</span>( label ) );
00295         }
00296 
00297         <span class="comment">// Nodes</span>
00298         NodeType node;
00299         <span class="keywordflow">while</span> ( !journal.atEnd() )
00300         {
00301                 journal.read( ( <span class="keywordtype">char</span>* ) &amp;node, <span class="keyword">sizeof</span>( node ) );
00302 
00303                 <span class="comment">// Move out the node</span>
00304                 storage_-&gt;seek( node.addr_ );
00305                 storage_-&gt;write( ( <span class="keywordtype">char</span>* ) &amp;node, <span class="keyword">sizeof</span>( node ) );
00306         }
00307 
00308         journal.setSource( 0 );
00309         journal_-&gt;resize( 0 );
00310         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00311 }
00312 
00313 <span class="comment">//      ===================================================================</span>
00314 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::isOpen</span>
00315 
00316 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00317"></a><a class="code" href="classStreamBTreeController.html#a2">00317</a> <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a2">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::isOpen</a>()
00318 {
00319         <span class="keywordflow">return</span> ( storage_ != 0 );
00320 }
00321 
00322 <span class="comment">//      ===================================================================</span>
00323 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::newNode</span>
00324 
00325 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00326 <span class="keyword">typename</span> <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;</a>::NodeType* 
00327                                 <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::newNode</a>()
00328 {
00329         <span class="keywordtype">int</span> addr = 0;
00330 
00331         <span class="keywordflow">if</span> ( !freeChunks_.empty() )
00332         {
00333                 freeChunks_.erase( freeChunks_.begin() );
00334         }
00335         <span class="keywordflow">else</span>
00336         {
00337                 addr = storage_-&gt;size();
00338         }
00339 
00340         NodeType *newnode = <span class="keyword">new</span> NodeType();
00341         newnode-&gt;addr_ = addr;
00342         newnode-&gt;flags_ = NodeType::NodeChanged;
00343 
00344         CacheData cacheData( newnode );
00345         saveNode( newnode );
00346         cache_[ addr ] = cacheData;
00347 
00348         <span class="keywordflow">return</span> newnode;
00349 }
00350 
00351 <span class="comment">//      ===================================================================</span>
00352 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::allocFreeSpace</span>
00353 
00354 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00355 <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::allocFreeSpace</a>()
00356 {
00357         gint64 fullSize = storage_-&gt;size() - <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> )*3;
00358         <span class="keywordflow">if</span> ( !fullSize ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00359 
00360         qint32 nodeCount = fullSize / <span class="keyword">sizeof</span>( NodeType );
00361         gint64 offset = <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> )*3;
00362 
00363         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; nodeCount; i++ )
00364         {
00365                 freeChunks_.insert( offset );
00366                 offset += <span class="keyword">sizeof</span>( NodeType );
00367         }
00368 
00369         <span class="keywordflow">if</span> ( !root_ ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00370 
00371         <span class="keywordflow">if</span> ( !readAllOffsets( root_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00372         freeChunks_.erase( root_-&gt;<a class="code" href="classBTreeNode.html#o0">addr_</a> );
00373         <a class="code" href="classStreamBTreeController.html#a4">releaseCache</a>();
00374         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00375 }
00376 
00377 <span class="comment">//      ===================================================================</span>
00378 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::readAllOffsets</span>
00379 
00380 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00381 <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::readAllOffsets</a>( 
00382                                 NodeType *node )
00383 {
00384         <span class="keywordflow">if</span> ( !node ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00385 
00386         <span class="keywordflow">if</span> ( node-&gt;less_ )
00387         {
00388                 NodeType *less;
00389                 <span class="keywordflow">if</span> ( !<a class="code" href="classStreamBTreeController.html#a14">loadNode</a>( &amp;less, node-&gt;less_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00390                 freeChunks_.erase( node-&gt;less_ );
00391                 readAllOffsets( less );
00392                 <span class="keywordflow">if</span> ( less ) <a class="code" href="classStreamBTreeController.html#a6">releaseNode</a>( less-&gt;addr_ );
00393 
00394                 <span class="comment">// Iterate other children if we have a less one</span>
00395                 <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; node-&gt;count(); i++ )
00396                 {
00397                         NodeType *kid = 0;
00398 
00399                         <span class="keywordflow">if</span> ( node-&gt;elems_[ i ].link_ )
00400                         {
00401                                 <span class="keywordflow">if</span> ( !<a class="code" href="classStreamBTreeController.html#a14">loadNode</a>( &amp;kid, node-&gt;elems_[ i ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00402                         }
00403                         freeChunks_.erase( node-&gt;elems_[ i ].link_ );
00404 
00405                         <span class="keywordflow">if</span> ( kid )
00406                         {
00407                                 readAllOffsets( kid );
00408                                 <a class="code" href="classStreamBTreeController.html#a6">releaseNode</a>( kid-&gt;addr_ );
00409                         }
00410                 }
00411         }
00412 
00413         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00414 }
00415 
00416 <span class="comment">//      ===================================================================</span>
00417 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::deleteNode</span>
00418 
00419 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00420 <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::deleteNode</a>( NodeType* node )
00421 {
00422         <span class="keyword">typename</span> ChunkCacheMap::iterator iter = cache_.find( node-&gt;addr_ );
00423 
00424         <span class="keywordflow">if</span> ( iter != cache_.end() )
00425         {
00426                 cache_.erase( iter );
00427         }
00428 
00429         freeChunks_.insert( node-&gt;addr_ );
00430         <span class="keyword">delete</span> node;
00431 }
00432 
00433 <span class="comment">//      ===================================================================</span>
00434 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::loadNode</span>
00435 
00436 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00437"></a><a class="code" href="classStreamBTreeController.html#a14">00437</a> <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a14">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::loadNode</a>( 
00438                         <a class="code" href="classBTreeNode.html">NodeType</a> **node, <span class="keywordtype">int</span> addr )
00439 {
00440         <span class="keywordflow">if</span> ( !addr )
00441         {
00442                 *node = 0;
00443                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00444         }
00445 
00446         <span class="keyword">typename</span> ChunkCacheMap::iterator iter = cache_.find( addr );
00447 
00448         <span class="keywordflow">if</span> ( iter == cache_.end() )
00449         {
00450                 *node = <span class="keyword">new</span> <a class="code" href="classBTreeNode.html">NodeType</a>();
00451                 storage_-&gt;seek( addr );
00452                 storage_-&gt;read( ( <span class="keywordtype">char</span>* ) *node, <span class="keyword">sizeof</span>( NodeType ) );
00453 
00454                 <span class="keywordflow">if</span> ( addr == ( *node )-&gt;addr_ )
00455                 {
00456                         CacheData cacheData( *node );
00457                         cache_[ addr ] = cacheData;
00458                 }
00459         }
00460         <span class="keywordflow">else</span>
00461         {
00462                 *node = iter-&gt;node;
00463         }
00464 
00465         <span class="keywordflow">if</span> ( ( *node )-&gt;addr_ != addr )
00466         {
00467                 <span class="comment">// Storage is corrupted!</span>
00468                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00469         }
00470 
00471         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00472 }
00473 
00474 <span class="comment">//      ===================================================================</span>
00475 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::saveNode</span>
00476 
00477 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00478 <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::saveNode</a>( NodeType *node )
00479 {
00480         node-&gt;<a class="code" href="classBTreeNode.html#o5">flags_</a> = 0;
00481         storage_-&gt;seek( node-&gt;addr_ );
00482         storage_-&gt;write( ( <span class="keyword">const</span> <span class="keywordtype">char</span>* ) node, <span class="keyword">sizeof</span>( NodeType ) );
00483 }
00484 
00485 <span class="comment">//      ===================================================================</span>
00486 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::flushChanges</span>
00487 
00488 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00489"></a><a class="code" href="classStreamBTreeController.html#a3">00489</a> <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a3">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::flushChanges</a>()
00490 {
00491         <span class="keywordflow">if</span> ( !storage_ ) <span class="keywordflow">return</span>;
00492 
00493         <span class="comment">// Journaling</span>
00494         <span class="keywordflow">if</span> ( journal_ )
00495         {
00496                 JBufferedOutputStream&lt; JStream &gt; journal( journal_ );
00497                 <span class="keywordflow">if</span> ( journal.size() &gt; 0 )
00498                 {
00499                         journal.resize( 0 );
00500                 }
00501 
00502                 <span class="keywordtype">bool</span> firstTime = <span class="keyword">true</span>;
00503                 guint complete = 0;
00504 
00505                 <span class="keyword">typename</span> ChunkCacheMap::iterator iter = cache_.begin();
00506                 <span class="keywordflow">for</span> ( ; iter != cache_.end(); iter++ )
00507                 {
00508                         <a class="code" href="classBTreeNode.html">NodeType</a> *node = iter-&gt;node;
00509 
00510                         <span class="keywordflow">if</span> ( NodeType::NodeChanged == node-&gt;<a class="code" href="classBTreeNode.html#o5">flags_</a> )
00511                         {
00512                                 <span class="keywordflow">if</span> ( firstTime )
00513                                 {
00514                                         <span class="comment">// Write completion label</span>
00515                                         journal.seek( 0 );
00516                                         journal.write( ( <span class="keywordtype">char</span>* ) &amp;complete, <span class="keyword">sizeof</span>( complete ) );
00517                                         journal.write( ( <span class="keywordtype">char</span>* ) &amp;rootAddr_, <span class="keyword">sizeof</span>( rootAddr_ ) );
00518                                         firstTime = <span class="keyword">false</span>;
00519                                 }
00520 
00521                                 node-&gt;<a class="code" href="classBTreeNode.html#o5">flags_</a> = 0;
00522                                 journal.write( ( <span class="keyword">const</span> <span class="keywordtype">char</span>* ) node, <span class="keyword">sizeof</span>( <a class="code" href="classBTreeNode.html">NodeType</a> ) );
00523                                 node-&gt;flags_ = NodeType::NodeChanged;
00524                         }
00525                 }
00526 
00527                 <span class="keywordflow">if</span> ( !firstTime )
00528                 {
00529                         <span class="comment">// Complete it</span>
00530                         journal.seekRaw( 0 );
00531                         complete = ~0;
00532                         journal.write( ( <span class="keywordtype">char</span>* ) &amp;complete, <span class="keyword">sizeof</span>( complete ) );
00533                         journal.flush();
00534                 }
00535                 journal.setSource( 0 );
00536         }
00537 
00538         <span class="comment">// Actual saving</span>
00539         <span class="keyword">typename</span> ChunkCacheMap::iterator iter = cache_.begin();
00540         <span class="keywordflow">for</span> ( ; iter != cache_.end(); iter++ )
00541         {
00542                 <span class="keywordflow">if</span> ( NodeType::NodeChanged == iter-&gt;node-&gt;flags_ )
00543                 {
00544                         <span class="comment">// Save node</span>
00545                         saveNode( iter-&gt;node );
00546                 }
00547         }
00548 
00549         <span class="comment">// Write root</span>
00550         <span class="keywordflow">if</span> ( rootAddr_ )
00551         {
00552                 storage_-&gt;seek( <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );
00553                 storage_-&gt;write( ( <span class="keywordtype">char</span>* ) &amp;rootAddr_, <span class="keyword">sizeof</span>( rootAddr_ ) );
00554                 rootAddr_ = 0;
00555         }
00556 
00557         <span class="comment">// Clear journal</span>
00558         <span class="keywordflow">if</span> ( journal_ ) journal_-&gt;resize( 0 );
00559 }
00560 
00561 <span class="comment">//      ===================================================================</span>
00562 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::releaseCache</span>
00563 
00564 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00565"></a><a class="code" href="classStreamBTreeController.html#a4">00565</a> <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a4">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::releaseCache</a>()
00566 {
00567         <span class="keywordflow">if</span> ( <a class="code" href="classStreamBTreeController.html#a7">cacheSize</a>() &gt; maxCacheSize_ )
00568         {
00569                 <a class="code" href="classStreamBTreeController.html#a5">clearCache</a>();
00570                 <span class="keywordflow">return</span>;
00571         }
00572 }
00573 
00574 <span class="comment">//      ===================================================================</span>
00575 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::clearCache</span>
00576 
00577 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00578"></a><a class="code" href="classStreamBTreeController.html#a5">00578</a> <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a5">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::clearCache</a>()
00579 {
00580         <a class="code" href="classStreamBTreeController.html#a3">flushChanges</a>();
00581 
00582         <span class="keyword">typename</span> ChunkCacheMap::iterator iter = cache_.begin();
00583         <span class="keywordflow">for</span> ( ; iter != cache_.end(); iter++ )
00584         {
00585                 <span class="keywordflow">if</span> ( iter-&gt;node != root_ )
00586                 {
00587                         <span class="keyword">delete</span> iter-&gt;node;
00588                 }
00589         }
00590 
00591         cache_.clear();
00592         <span class="keywordflow">if</span> ( root_ )
00593         {
00594                 cache_[ root_-&gt;<a class="code" href="classBTreeNode.html#o0">addr_</a> ] = CacheData( root_ );
00595         }
00596 }
00597 
00598 <span class="comment">//      ===================================================================</span>
00599 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::releaseNode</span>
00600 
00601 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00602"></a><a class="code" href="classStreamBTreeController.html#a6">00602</a> <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a6">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::releaseNode</a>( <span class="keywordtype">int</span> addr )
00603 {
00604         <span class="keyword">typename</span> ChunkCacheMap::iterator iter = cache_.find( addr );
00605 
00606         <span class="keywordflow">if</span> ( cache_.end() != iter )
00607         {
00608                 <span class="keywordflow">if</span> ( NodeType::NodeChanged == iter-&gt;node-&gt;flags_ )
00609                 {
00610                         <a class="code" href="classStreamBTreeController.html#a3">flushChanges</a>();
00611                         <a class="code" href="classStreamBTreeController.html#a6">releaseNode</a>( addr );
00612                         <span class="keywordflow">return</span>;
00613                 }
00614 
00615                 <span class="keywordflow">if</span> ( iter-&gt;node != root_ )
00616                 {
00617                         <span class="keyword">delete</span> iter-&gt;node;
00618                         cache_.erase( iter );
00619                 }
00620         }
00621 }
00622 
00623 <span class="comment">//      ===================================================================</span>
00624 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::rootAddr</span>
00625 
00626 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00627 <span class="keywordtype">int</span> <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::rootAddr</a>()
00628 {
00629         <span class="keywordtype">int</span> addr = 0;
00630         storage_-&gt;seek( <span class="keyword">sizeof</span>( <span class="keywordtype">int</span> ) );
00631         storage_-&gt;read( ( <span class="keywordtype">char</span>* ) &amp;addr, <span class="keyword">sizeof</span>( addr ) );
00632         <span class="keywordflow">return</span> addr;
00633 }
00634 
00635 <span class="comment">//      ===================================================================</span>
00636 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::closeController</span>
00637 
00638 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00639 <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::closeController</a>()
00640 {
00641         cache_.clear();
00642 
00643         <span class="keywordflow">if</span> ( storage_ )
00644         {
00645                 <span class="keywordflow">if</span> ( !freeChunks_.empty() )
00646                 {
00647                         <span class="comment">// Save removed nodes list</span>
00648                         guint rlistAddr = storage_-&gt;size();
00649                         QByteArray rblock;
00650                         FreeChunksSet::const_iterator iter = freeChunks_.begin();
00651                         guint aaddr = 0;
00652                         <span class="keywordflow">for</span> ( ; iter != freeChunks_.end(); iter++ )
00653                         {
00654                                 aaddr = *iter;
00655                                 rblock.resize( rblock.size() + <span class="keyword">sizeof</span>( aaddr ) );
00656                                 ::memcpy( rblock.data() + rblock.size() - <span class="keyword">sizeof</span>( aaddr ), 
00657                                         ( <span class="keywordtype">char</span>* ) &amp;aaddr, <span class="keyword">sizeof</span>( aaddr ) );
00658                         }
00659                         freeChunks_.clear();
00660 
00661                         storage_-&gt;seek( rlistAddr );
00662                         storage_-&gt;write( rblock.data(), rblock.size() );
00663 
00664                         storage_-&gt;seek( constRemovedAddr );
00665                         storage_-&gt;write( ( <span class="keywordtype">char</span>* ) &amp;rlistAddr, <span class="keyword">sizeof</span>( rlistAddr ) );
00666                 }
00667 
00668                 storage_-&gt;close();
00669                 storage_ = 0;
00670 
00671                 <span class="keywordflow">if</span> ( journal_ )
00672                 {
00673                         journal_-&gt;close();
00674                         journal_ = 0;
00675                 }
00676         }
00677 }
00678 
00679 <span class="comment">//      ===================================================================</span>
00680 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::rootAddr</span>
00681 
00682 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00683 <span class="keywordtype">void</span> StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::rootAddr( <span class="keywordtype">int</span> addr )
00684 {
00685         rootAddr_ = addr;
00686 }
00687 
00688 <span class="comment">//      ===================================================================</span>
00689 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::rootAddr</span>
00690 
00691 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00692"></a><a class="code" href="classStreamBTreeController.html#a7">00692</a> guint <a class="code" href="classStreamBTreeController.html#a7">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::cacheSize</a>()<span class="keyword"> const</span>
00693 <span class="keyword"></span>{
00694         <span class="keywordflow">return</span> <span class="keyword">sizeof</span>( <a class="code" href="classBTreeNode.html">NodeType</a> )*cache_.size();
00695 }
00696 
00697 <span class="comment">//      ===================================================================</span>
00698 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::setMaxCacheSize</span>
00699 
00700 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00701"></a><a class="code" href="classStreamBTreeController.html#a8">00701</a> <span class="keywordtype">void</span> <a class="code" href="classStreamBTreeController.html#a8">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::setMaxCacheSize</a>( guint maxSize )
00702 {
00703         maxCacheSize_ = maxSize;
00704 }
00705 
00706 <span class="comment">//      ===================================================================</span>
00707 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::getMaxCacheSize</span>
00708 
00709 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00710"></a><a class="code" href="classStreamBTreeController.html#a9">00710</a> guint <a class="code" href="classStreamBTreeController.html#a9">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::getMaxCacheSize</a>()
00711 {
00712         <span class="keywordflow">return</span> maxCacheSize_;
00713 }
00714 
00715 <span class="comment">//      ===================================================================</span>
00716 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::getMaxCacheSize</span>
00717 
00718 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00719"></a><a class="code" href="classStreamBTreeController.html#a10">00719</a> <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a10">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::nodeInCache</a>( <span class="keywordtype">int</span> addr )
00720 {
00721         <span class="keywordflow">return</span> cache_.end() != cache_.find( addr );
00722 }
00723 
00724 <span class="comment">//      ===================================================================</span>
00725 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::getMaxCacheSize</span>
00726 
00727 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00728"></a><a class="code" href="classStreamBTreeController.html#a11">00728</a> JStream* <a class="code" href="classStreamBTreeController.html#a11">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::storage</a>()
00729 {
00730         <span class="keywordflow">return</span> storage_;
00731 }
00732 
00733 <span class="comment">//      ===================================================================</span>
00734 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::clear</span>
00735 
00736 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
<a name="l00737"></a><a class="code" href="classStreamBTreeController.html#a12">00737</a> <span class="keywordtype">bool</span> <a class="code" href="classStreamBTreeController.html#a12">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::clear</a>()
00738 {
00739         <span class="comment">// Clear cache</span>
00740         <span class="keyword">typename</span> ChunkCacheMap::iterator iter = cache_.begin();
00741         <span class="keywordflow">for</span> ( ; iter != cache_.end(); iter++ )
00742         {
00743                 <span class="keyword">delete</span> iter-&gt;node;
00744         }
00745 
00746         cache_.clear();
00747         freeChunks_.clear();
00748         root_  = 0;
00749 
00750         JStream *treeStorage = storage_;
00751         storage_-&gt;resize( 0 );
00752         storage_ = 0;
00753 
00754         <span class="keywordflow">return</span> <a class="code" href="classStreamBTreeController.html#a1">open</a>( treeStorage, maxCacheSize_ );
00755 }
00756 
00757 <span class="comment">//      ===================================================================</span>
00758 <span class="comment">//      StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::root</span>
00759 
00760 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT &gt;
00761 <span class="keyword">typename</span> <a class="code" href="classStreamBTreeController.html">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;</a>::NodeType* 
<a name="l00762"></a><a class="code" href="classStreamBTreeController.html#a13">00762</a>                 <a class="code" href="classStreamBTreeController.html#a13">StreamBTreeController&lt; NodeSize, KeyT, DataT &gt;::root</a>()
00763 {
00764         <span class="keywordflow">return</span> root_;
00765 }
00766 
00767 <span class="preprocessor">#endif // __StreamBTreeController_h__</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 18 11:38:50 2007 for EmbeddedFileSystem by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
