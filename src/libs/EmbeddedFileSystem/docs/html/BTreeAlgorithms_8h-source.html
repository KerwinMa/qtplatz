<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>EmbeddedFileSystem: BTreeAlgorithms.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<h1>BTreeAlgorithms.h</h1><div class="fragment"><pre>00001 
00002 
00003 
00004 
00005 
00006 
00007 
00008 
00009 <span class="preprocessor">#ifndef __BTreeAlgorithms_h__</span>
00010 <span class="preprocessor"></span><span class="preprocessor">#define __BTreeAlgorithms_h__</span>
00011 <span class="preprocessor"></span>
00012 <span class="preprocessor">#include "BTreeNode.h"</span>
00013 
00017 
00018 <span class="keyword">template</span>
00019 &lt;
00020         <span class="keywordtype">int</span> NodeSize,
00021         <span class="keyword">typename</span> KeyT,
00022         <span class="keyword">typename</span> DataT,
00023         <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController
00024 &gt;
<a name="l00025"></a><a class="code" href="classBTreeAlgorithms.html">00025</a> <span class="keyword">class </span><a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms</a> : <span class="keyword">public</span> TController&lt; NodeSize, KeyT, DataT &gt;
00026 {
00027 <span class="keyword">public</span>:
00028 
00029         <span class="keyword">typedef</span> <a class="code" href="classBTreeNode.html">BTreeNode&lt; NodeSize, KeyT, DataT &gt;</a> <a class="code" href="classBTreeNode.html">NodeType</a>;
00030         <span class="keyword">enum</span> { nodeSize = NodeSize };
00031 
00032         <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms</a>();
00033         ~<a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms</a>();
00034 
00037         <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a2">add</a>( <span class="keyword">const</span> KeyT &amp;key, <span class="keyword">const</span> DataT &amp;data );
00038 
00041         <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a3">remove</a>( <span class="keyword">const</span> KeyT &amp;key );
00042 
00045         <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a3">remove</a>( <span class="keyword">const</span> KeyT &amp;key, DataT &amp;data );
00046 
00049         <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a5">find</a>( <span class="keyword">const</span> KeyT &amp;key, DataT &amp;data );
00050 
00053         <span class="keyword">template</span>&lt; <span class="keyword">class</span> TChecker, <span class="keyword">class</span> TContainer &gt;
00054         <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a6">search</a>( TContainer &amp;retList, <span class="keyword">const</span> KeyT &amp;startKey, 
00055                 <span class="keywordtype">bool</span> preciseSearch, TChecker &amp;condition );
00056 
00059         <span class="keyword">template</span>&lt; <span class="keyword">class</span> TContainer &gt;
00060         <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a7">getAll</a>( TContainer &amp;retList );
00061 
00064         <span class="keywordtype">void</span> <a class="code" href="classBTreeAlgorithms.html#a8">changeData</a>( <span class="keyword">const</span> KeyT &amp;key, <span class="keyword">const</span> DataT &amp;newData );
00065 
00068         <span class="keywordtype">void</span> <a class="code" href="classBTreeAlgorithms.html#a9">close</a>();
00069 
00070 <span class="keyword">protected</span>:
00071 
00072         <span class="keywordtype">int</span> getMedian( <a class="code" href="classBTreeNode.html">NodeType</a> *node, <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> &amp;elem );
00073 
00074         <span class="keywordtype">void</span> splitNodeByKey( <a class="code" href="classBTreeNode.html">NodeType</a> **fullNode, KeyT &amp;key );
00075         <span class="keywordtype">bool</span> splitNode( <a class="code" href="classBTreeNode.html">NodeType</a> *node, 
00076                 <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> &amp;median, <a class="code" href="classBTreeNode.html">NodeType</a> **nodeRight );
00077 
00078         <a class="code" href="classBTreeNode.html">NodeType</a>* findNode( <a class="code" href="classBTreeNode.html">NodeType</a> *node, <span class="keyword">const</span> KeyT &amp;key, <span class="keywordtype">int</span> &amp;retIndex, 
00079                 <span class="keywordtype">int</span> &amp;parentIndex, <span class="keywordtype">bool</span> &amp;found );
00080 
00081         <span class="keywordtype">bool</span> rebalance( <a class="code" href="classBTreeNode.html">NodeType</a> *node, <span class="keywordtype">int</span> parentIndex );
00082         <span class="keywordtype">bool</span> combine( <a class="code" href="classBTreeNode.html">NodeType</a> *leftNode, <a class="code" href="classBTreeNode.html">NodeType</a> *rightNode );
00083         <span class="keywordtype">bool</span> pullOut( <a class="code" href="classBTreeNode.html">NodeType</a> *node, <span class="keywordtype">int</span> itemIndex );
00084 
00085         <a class="code" href="classBTreeNode.html">NodeType</a>* rightMost( <a class="code" href="classBTreeNode.html">NodeType</a> *subtree, KeyT &amp;largestKey, DataT &amp;largestData );
00086         <a class="code" href="classBTreeNode.html">NodeType</a>* leftMost( <a class="code" href="classBTreeNode.html">NodeType</a> *subtree, KeyT &amp;smallestKey, DataT &amp;smallestData );
00087 
00088         <span class="comment">// Internal search methods</span>
00089         <span class="keyword">template</span> &lt; <span class="keyword">class</span> TChecker, <span class="keyword">class</span> TContainer &gt;
00090         <span class="keywordtype">bool</span> allKeys( <a class="code" href="classBTreeNode.html">NodeType</a> *node, TContainer &amp;retList, <span class="keywordtype">int</span> elemIndex, 
00091                 <span class="keyword">const</span> KeyT &amp;startKey, TChecker &amp;condition );
00092         <span class="keyword">template</span> &lt; <span class="keyword">class</span> TChecker, <span class="keyword">class</span> TContainer &gt;
00093         <span class="keywordtype">bool</span> allKeys( <a class="code" href="classBTreeNode.html">NodeType</a> *node, TContainer &amp;retList, TChecker &amp;condition );
00094         <span class="keyword">template</span>&lt; <span class="keyword">class</span> TContainer &gt;
00095         <span class="keywordtype">bool</span> allKeys( <a class="code" href="classBTreeNode.html">NodeType</a> *node, TContainer &amp;retList );
00096 
00097 };
00098 
00099 <span class="comment">//      ===================================================================</span>
00100 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::BTreeAlgorithms</span>
00101 
00102 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00103 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00104 <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::BTreeAlgorithms</a>()
00105 {}
00106 
00107 <span class="comment">//      ===================================================================</span>
00108 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::~BTreeAlgorithms</span>
00109 
00110 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00111 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00112 <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::~BTreeAlgorithms</a>()
00113 {
00114         <a class="code" href="classBTreeAlgorithms.html#a9">close</a>();
00115 }
00116 
00117 <span class="comment">//      ===================================================================</span>
00118 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::add</span>
00119 
00120 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00121 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
<a name="l00122"></a><a class="code" href="classBTreeAlgorithms.html#a2">00122</a> <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a2">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::add</a>( <span class="keyword">const</span> KeyT &amp;key, 
00123                                                                                                 <span class="keyword">const</span> DataT &amp;data )
00124 {
00125         <span class="keywordflow">if</span> ( !isOpen() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00126 
00127         <span class="keywordflow">if</span> ( !root_ )
00128         {
00129                 <span class="keywordtype">int</span> addr = rootAddr();
00130                 <span class="keywordflow">if</span> ( !addr )
00131                 {
00132                         root_ = newNode();
00133                         root_-&gt;flags_ = NodeType::NodeChanged;
00134                         rootAddr( root_-&gt;addr_ );
00135                 }
00136                 <span class="keywordflow">else</span>
00137                 {
00138                         <span class="keywordflow">if</span> ( !loadNode( &amp;root_, addr ) )
00139                         {
00140                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00141                         }
00142                 }
00143         }
00144 
00145         <span class="keywordflow">if</span> ( !root_ ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00146 
00147         <span class="comment">// Find targeted node</span>
00148         <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00149         KeyT copyKey( key );
00150         DataT copyData( data );
00151         <span class="keywordtype">int</span> retIndex = -1, parentIndex = 0;
00152 
00153         <a class="code" href="classBTreeNode.html">NodeType</a> *node = findNode( root_, copyKey, retIndex, parentIndex, found );
00154 
00155         <span class="keywordflow">if</span> ( found || !node )
00156         {
00157                 <span class="comment">// Duplicate keys are not accepted</span>
00158                 releaseCache();
00159                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00160         }
00161 
00162         <span class="keywordflow">if</span> ( !node-&gt;<a class="code" href="classBTreeNode.html#a10">isFull</a>() )
00163         {
00164                 <span class="comment">// Just add to not full node</span>
00165                 node-&gt;<a class="code" href="classBTreeNode.html#a2">add</a>( copyKey, copyData );
00166                 releaseCache();
00167                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00168         }
00169         <span class="keywordflow">else</span>
00170         {
00171                 <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> median;
00172                 median.<a class="code" href="classBTreeElement.html#o0">key_</a> = key;
00173                 median.<a class="code" href="classBTreeElement.html#o1">data_</a> = data;
00174                 <a class="code" href="classBTreeNode.html">NodeType</a> *nodeRight = 0;
00175                 <a class="code" href="classBTreeNode.html">NodeType</a> *parent = 0;
00176                 <span class="keywordflow">if</span> ( !loadNode( &amp;parent, node-&gt;<a class="code" href="classBTreeNode.html#o4">parent_</a> ) )
00177                 {
00178                         releaseCache();
00179                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00180                 }
00181 
00182                 <span class="comment">// Split node and get median</span>
00183                 <span class="keywordflow">if</span> ( !splitNode( node, median, &amp;nodeRight ) )
00184                 {
00185                         releaseCache();
00186                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00187                 }
00188 
00189                 <span class="keywordflow">while</span> ( 0 != parent )
00190                 {
00191                         <span class="comment">// Add median to the parent</span>
00192                         <span class="keywordflow">if</span> ( parent-&gt;<a class="code" href="classBTreeNode.html#a10">isFull</a>() )
00193                         {
00194                                 <span class="keywordflow">if</span> ( !splitNode( parent, median, &amp;nodeRight ) )
00195                                 {
00196                                         releaseCache();
00197                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00198                                 }
00199 
00200                                 node = parent;
00201 
00202                                 <span class="comment">// Move up</span>
00203                                 <span class="keywordflow">if</span> ( !loadNode( &amp;parent, parent-&gt;parent_ ) )
00204                                 {
00205                                         releaseCache();
00206                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00207                                 }
00208                         }
00209                         <span class="keywordflow">else</span>
00210                         {
00211                                 parent-&gt;<a class="code" href="classBTreeNode.html#a2">add</a>( median );
00212                                 parent-&gt;<a class="code" href="classBTreeNode.html#o5">flags_</a> = NodeType::NodeChanged;
00213                                 nodeRight-&gt;<a class="code" href="classBTreeNode.html#o4">parent_</a> = parent-&gt;<a class="code" href="classBTreeNode.html#o0">addr_</a>;
00214                                 nodeRight-&gt;<a class="code" href="classBTreeNode.html#o5">flags_</a> = NodeType::NodeChanged;
00215                                 <span class="keywordflow">break</span>;
00216                         }
00217                 }
00218 
00219                 <span class="keywordflow">if</span> ( !parent )
00220                 {
00221                         <span class="comment">// The root node!</span>
00222                         root_ = newNode();
00223                         rootAddr( root_-&gt;addr_ );
00224                         node-&gt;<a class="code" href="classBTreeNode.html#o4">parent_</a> = root_-&gt;addr_;
00225                         node-&gt;<a class="code" href="classBTreeNode.html#o5">flags_</a> = NodeType::NodeChanged;
00226                         nodeRight-&gt;<a class="code" href="classBTreeNode.html#o4">parent_</a> = root_-&gt;addr_;
00227                         nodeRight-&gt;<a class="code" href="classBTreeNode.html#o5">flags_</a> = NodeType::NodeChanged;
00228 
00229                         root_-&gt;add( median.<a class="code" href="classBTreeElement.html#o0">key_</a>, median.<a class="code" href="classBTreeElement.html#o1">data_</a> );
00230                         root_-&gt;elems_[ 0 ].link_ = nodeRight-&gt;<a class="code" href="classBTreeNode.html#o0">addr_</a>;
00231                         root_-&gt;less_ = node-&gt;<a class="code" href="classBTreeNode.html#o0">addr_</a>;
00232                 }
00233         }
00234 
00235         releaseCache();
00236         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00237 }
00238 
00239 <span class="comment">//      ===================================================================</span>
00240 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::remove</span>
00241 
00242 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00243 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
<a name="l00244"></a><a class="code" href="classBTreeAlgorithms.html#a3">00244</a> <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a3">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::remove</a>( <span class="keyword">const</span> KeyT &amp;key )
00245 {
00246         <span class="keywordflow">if</span> ( !root_ )
00247         {
00248                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00249         }
00250 
00251         <span class="comment">// Find targeted node</span>
00252         <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00253         <span class="keywordtype">int</span> retIndex = -1, parentIndex = 0;
00254 
00255         <a class="code" href="classBTreeNode.html">NodeType</a> *node = findNode( root_, key, retIndex, parentIndex, found );
00256 
00257         <span class="keywordflow">if</span> ( !found || !node )
00258         {
00259                 <span class="comment">// Key not found</span>
00260                 releaseCache();
00261                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00262         }
00263 
00264         <span class="keywordflow">if</span> ( !node-&gt;<a class="code" href="classBTreeNode.html#a8">hasChilds</a>() )
00265         {
00266                 node-&gt;<a class="code" href="classBTreeNode.html#a4">removeAt</a>( retIndex );
00267                 <span class="keywordflow">if</span> ( !rebalance( node, parentIndex ) )
00268                 {
00269                         releaseCache();
00270                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00271                 }
00272         }
00273         <span class="keywordflow">else</span>
00274         {
00275                 <span class="keywordflow">if</span> ( !pullOut( node, retIndex ) )
00276                 {
00277                         releaseCache();
00278                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00279                 }
00280         }
00281 
00282         releaseCache();
00283         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00284 }
00285 
00286 <span class="comment">//      ===================================================================</span>
00287 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::remove</span>
00288 
00289 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00290 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
<a name="l00291"></a><a class="code" href="classBTreeAlgorithms.html#a4">00291</a> <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a3">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::remove</a>( <span class="keyword">const</span> KeyT &amp;key, 
00292                                                                                                                 DataT &amp;data )
00293 {
00294         <span class="keywordflow">if</span> ( !root_ )
00295         {
00296                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00297         }
00298 
00299         <span class="comment">// Find targeted node</span>
00300         <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00301         <span class="keywordtype">int</span> retIndex = -1, parentIndex = 0;
00302 
00303         <a class="code" href="classBTreeNode.html">NodeType</a> *node = findNode( root_, key, retIndex, parentIndex, found );
00304 
00305         <span class="keywordflow">if</span> ( !found || !node )
00306         {
00307                 <span class="comment">// Key not found</span>
00308                 releaseCache();
00309                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00310         }
00311         <span class="keywordflow">else</span>
00312         {
00313                 data = node-&gt;<a class="code" href="classBTreeNode.html#o2">elems_</a>[ retIndex ].data_;
00314         }
00315 
00316         <span class="keywordflow">if</span> ( !node-&gt;<a class="code" href="classBTreeNode.html#a8">hasChilds</a>() )
00317         {
00318                 node-&gt;<a class="code" href="classBTreeNode.html#a4">removeAt</a>( retIndex );
00319                 <span class="keywordflow">if</span> ( !rebalance( node, parentIndex ) )
00320                 {
00321                         releaseCache();
00322                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00323                 }
00324         }
00325         <span class="keywordflow">else</span>
00326         {
00327                 <span class="keywordflow">if</span> ( !pullOut( node, retIndex ) )
00328                 {
00329                         releaseCache();
00330                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00331                 }
00332         }
00333 
00334         releaseCache();
00335         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00336 }
00337 
00338 <span class="comment">//      ===================================================================</span>
00339 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::find</span>
00340 
00341 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00342 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
<a name="l00343"></a><a class="code" href="classBTreeAlgorithms.html#a5">00343</a> <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a5">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::find</a>( <span class="keyword">const</span> KeyT &amp;key, 
00344                                                                 DataT &amp;data )
00345 {
00346         <span class="keywordflow">if</span> ( !root_ )
00347         {
00348                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00349         }
00350 
00351         <span class="keywordtype">int</span> index = 0, parentIndex = 0;
00352         <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00353         <a class="code" href="classBTreeNode.html">NodeType</a> *node = findNode( root_, key, index, parentIndex, found );
00354 
00355         <span class="keywordflow">if</span> ( !node || index &lt; 0 )
00356         {
00357                 releaseCache();
00358                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00359         }
00360 
00361         <span class="keywordflow">if</span> ( found )
00362         {
00363                 <span class="comment">// Key found</span>
00364                 data = node-&gt;<a class="code" href="classBTreeNode.html#o2">elems_</a>[ index ].data_;
00365                 releaseCache();
00366                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00367         }
00368 
00369         releaseCache();
00370 
00371         <span class="comment">// Key not found</span>
00372         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00373 }
00374 
00375 <span class="comment">//      ===================================================================</span>
00376 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::search</span>
00377 
00378 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00379 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00380 <span class="keyword">template</span> &lt; <span class="keyword">class</span> TChecker, <span class="keyword">class</span> TContainer &gt;
<a name="l00381"></a><a class="code" href="classBTreeAlgorithms.html#a6">00381</a> <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a6">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::search</a>( 
00382                 TContainer &amp;retList, <span class="keyword">const</span> KeyT &amp;startKey, <span class="keywordtype">bool</span> preciseSearch,
00383                 TChecker &amp;condition )
00384 {
00385         retList.clear();
00386 
00387         <span class="comment">// Find targeted node</span>
00388         <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00389         <span class="keywordtype">int</span> retIndex = -1, parentIndex = 0;
00390         <a class="code" href="classBTreeNode.html">NodeType</a> *node = findNode( root_, startKey, retIndex, parentIndex, found );
00391 
00392         <span class="keywordflow">if</span> ( ( preciseSearch &amp;&amp; !found ) || !node )
00393         {
00394                 releaseCache();
00395                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00396         }
00397 
00398         <span class="keywordflow">if</span> ( !allKeys( node, retList, retIndex, startKey, condition ) )
00399         {
00400                 releaseCache();
00401                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00402         }
00403 
00404         releaseCache();
00405         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00406 }
00407 
00408 <span class="comment">//      ===================================================================</span>
00409 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::getAll</span>
00410 
00411 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00412 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00413 <span class="keyword">template</span> &lt; <span class="keyword">class</span> TContainer &gt;
<a name="l00414"></a><a class="code" href="classBTreeAlgorithms.html#a7">00414</a> <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html#a7">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::getAll</a>( TContainer &amp;retList )
00415 {
00416         <span class="keywordflow">if</span> ( !allKeys( root_, retList ) )
00417         {
00418                 releaseCache();
00419                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00420         }
00421 
00422         releaseCache();
00423         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00424 }
00425 
00426 <span class="comment">//      ===================================================================</span>
00427 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::changeData</span>
00428 
00429 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00430 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
<a name="l00431"></a><a class="code" href="classBTreeAlgorithms.html#a8">00431</a> <span class="keywordtype">void</span> <a class="code" href="classBTreeAlgorithms.html#a8">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::changeData</a>( <span class="keyword">const</span> KeyT &amp;key, 
00432                                                                                         <span class="keyword">const</span> DataT &amp;newData )
00433 {
00434         <span class="keywordflow">if</span> ( !root_ )
00435         {
00436                 <span class="keywordflow">return</span>;
00437         }
00438 
00439         <span class="keywordtype">int</span> index = 0, parentIndex = 0;
00440         <span class="keywordtype">bool</span> found = <span class="keyword">false</span>;
00441         <a class="code" href="classBTreeNode.html">NodeType</a> *node = findNode( root_, key, index, parentIndex, found );
00442 
00443         <span class="keywordflow">if</span> ( !node || index &lt; 0 )
00444         {
00445                 releaseCache();
00446                 <span class="keywordflow">return</span>;
00447         }
00448 
00449         <span class="keywordflow">if</span> ( found )
00450         {
00451                 <span class="comment">// Key found</span>
00452                 node-&gt;<a class="code" href="classBTreeNode.html#o2">elems_</a>[ index ].data_ = newData;
00453                 node-&gt;<a class="code" href="classBTreeNode.html#o5">flags_</a> = NodeType::NodeChanged;
00454                 releaseCache();
00455                 <span class="keywordflow">return</span>;
00456         }
00457 
00458         releaseCache();
00459 }
00460 
00461 <span class="comment">//      ===================================================================</span>
00462 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::allKeys</span>
00463 
00464 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00465 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00466 <span class="keyword">template</span> &lt; <span class="keyword">class</span> TChecker, <span class="keyword">class</span> TContainer &gt;
00467 <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::allKeys</a>( 
00468                 NodeType *node, TContainer &amp;retList, <span class="keywordtype">int</span> elemIndex,
00469                 <span class="keyword">const</span> KeyT &amp;startKey, TChecker &amp;condition )
00470 {
00471         <span class="keywordflow">if</span> ( !node ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00472 
00473         <span class="keywordflow">if</span> ( -1 == elemIndex )
00474         {
00475                 node-&gt;find( startKey, elemIndex );
00476                 <span class="keywordflow">if</span> ( -1 == elemIndex )
00477                 {
00478                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00479                 }
00480         }
00481 
00482         <span class="keywordtype">int</span> i = elemIndex;
00483         <span class="comment">//if ( i &gt; 0 ) i--;</span>
00484 
00485         <span class="keywordflow">while</span> ( i &lt; node-&gt;size_ )
00486         {
00487                 <span class="keywordflow">if</span> ( condition.satisfy( node-&gt;elems_[ i ].key_ ) )
00488                 {
00489                         retList.push_back( TContainer::ElemType( node-&gt;elems_[ i ] ) );
00490 
00491                         <span class="keywordflow">if</span> ( node-&gt;elems_[ i ].link_ )
00492                         {
00493                                 <span class="comment">// Examine each child item</span>
00494                                 NodeType *child = 0;
00495                                 <span class="keywordtype">bool</span> wasInCache = nodeInCache( node-&gt;elems_[ i ].link_ );
00496                                 <span class="keywordflow">if</span> ( !loadNode( &amp;child, node-&gt;elems_[ i ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00497                                 allKeys( child, retList, condition );
00498                                 <span class="keywordflow">if</span> ( child &amp;&amp; !wasInCache ) releaseNode( child-&gt;addr_ );
00499                         }
00500                 }
00501                 <span class="keywordflow">else</span>
00502                 {
00503                         <span class="keywordflow">break</span>;
00504                 }
00505 
00506                 <span class="comment">// Move to node end</span>
00507                 i++;
00508         }
00509 
00510         <span class="keywordflow">if</span> ( !node-&gt;parent_ )
00511         {
00512                 <span class="comment">// End of search has reached</span>
00513                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00514         }
00515 
00516         <span class="comment">// Move to up</span>
00517         NodeType *parent = 0;
00518         <span class="keywordtype">bool</span> wasInCache = nodeInCache( node-&gt;parent_ );
00519         <span class="keywordflow">if</span> ( !loadNode( &amp;parent, node-&gt;parent_ ) )
00520         {
00521                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00522         }
00523 
00524         <span class="keywordtype">bool</span> ret = allKeys( parent, retList, -1, startKey, condition );
00525         <span class="keywordflow">if</span> ( parent &amp;&amp; !wasInCache ) releaseNode( parent-&gt;addr_ );
00526         <span class="keywordflow">return</span> ret;
00527 }
00528 
00529 <span class="comment">//      ===================================================================</span>
00530 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::allKeys</span>
00531 
00532 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00533 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00534 <span class="keyword">template</span> &lt; <span class="keyword">class</span> TChecker, <span class="keyword">class</span> TContainer &gt;
00535 <span class="keywordtype">bool</span> BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::allKeys( 
00536         NodeType *node, TContainer &amp;retList, TChecker &amp;condition )
00537 {
00538         <span class="keywordflow">if</span> ( !node ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00539 
00540         <span class="keywordflow">if</span> ( node-&gt;less_ )
00541         {
00542                 NodeType *less = 0;
00543 
00544                 <span class="keywordtype">bool</span> wasInCache = nodeInCache( node-&gt;less_ );
00545                 <span class="keywordflow">if</span> ( !loadNode( &amp;less, node-&gt;less_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00546                 <span class="keywordflow">if</span> ( !allKeys( less, retList ) )
00547                 {
00548                         <span class="comment">// End of the condition had reached</span>
00549                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00550                 }
00551 
00552                 <span class="keywordflow">if</span> ( less &amp;&amp; !wasInCache ) releaseNode( less-&gt;addr_ );
00553         }
00554 
00555         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; node-&gt;size_; i++ )
00556         {
00557                 <span class="comment">// Apply condition</span>
00558                 <span class="keywordflow">if</span> ( !condition.satisfy( node-&gt;elems_[ i ].key_ ) )
00559                 {
00560                         <span class="comment">// Stop key reached</span>
00561                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00562                 }
00563 
00564                 retList.push_back( TContainer::ElemType( node-&gt;elems_[ i ] ) );
00565 
00566                 <span class="keywordflow">if</span> ( node-&gt;elems_[ i ].link_ )
00567                 {
00568                         NodeType *kid = 0;
00569                         <span class="keywordtype">bool</span> wasInCache = nodeInCache( node-&gt;elems_[ i ].link_ );
00570                         <span class="keywordflow">if</span> ( !loadNode( &amp;kid, node-&gt;elems_[ i ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00571                         <span class="keywordflow">if</span> ( !allKeys( kid, retList ) )
00572                         {
00573                                 <span class="comment">// End of tree or condition had reached</span>
00574                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00575                         }
00576                         <span class="keywordflow">if</span> ( kid &amp;&amp; !wasInCache ) releaseNode( kid-&gt;addr_ );
00577                 }
00578         }
00579 
00580         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00581 }
00582 
00583 <span class="comment">//      ===================================================================</span>
00584 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::allKeys</span>
00585 
00586 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00587 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00588 <span class="keyword">template</span> &lt; <span class="keyword">class</span> TContainer &gt;
00589 <span class="keywordtype">bool</span> BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::allKeys( 
00590         NodeType *node, TContainer &amp;retList )
00591 {
00592         <span class="keywordflow">if</span> ( !node ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00593 
00594         <span class="keywordflow">if</span> ( node-&gt;less_ )
00595         {
00596                 NodeType *less = 0;
00597 
00598                 <span class="keywordtype">bool</span> wasInCache = nodeInCache( node-&gt;less_ );
00599                 <span class="keywordflow">if</span> ( !loadNode( &amp;less, node-&gt;less_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00600                 <span class="keywordflow">if</span> ( !allKeys( less, retList ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00601                 <span class="keywordflow">if</span> ( less &amp;&amp; !wasInCache ) releaseNode( less-&gt;addr_ );
00602         }
00603 
00604         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; node-&gt;count(); i++ )
00605         {
00606                 retList.push_back( TContainer::ElemType( node-&gt;elems_[ i ] ) );
00607 
00608                 <span class="keywordflow">if</span> ( node-&gt;elems_[ i ].link_ )
00609                 {
00610                         NodeType *kid = 0;
00611 
00612                         <span class="keywordtype">bool</span> wasInCache = nodeInCache( node-&gt;elems_[ i ].link_ );
00613                         <span class="keywordflow">if</span> ( !loadNode( &amp;kid, node-&gt;elems_[ i ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00614                         <span class="keywordflow">if</span> ( !allKeys( kid, retList ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00615                         <span class="keywordflow">if</span> ( kid &amp;&amp; !wasInCache ) releaseNode( kid-&gt;addr_ );
00616                 }
00617         }
00618 
00619         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00620 }
00621 
00622 <span class="comment">//      ===================================================================</span>
00623 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::close</span>
00624 
00625 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00626 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
<a name="l00627"></a><a class="code" href="classBTreeAlgorithms.html#a9">00627</a> <span class="keywordtype">void</span> <a class="code" href="classBTreeAlgorithms.html#a9">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::close</a>()
00628 {
00629         setMaxCacheSize( 0 );
00630         releaseCache();
00631         <span class="keyword">delete</span> root_;
00632         root_ = 0;
00633 
00634         closeController();
00635 }
00636 
00637 <span class="comment">//      ===================================================================</span>
00638 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::rebalance</span>
00639 
00640 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00641 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00642 <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::rebalance</a>( NodeType *node, <span class="keywordtype">int</span> parentIndex )
00643 {
00644         <span class="keywordtype">int</span> minimal = node-&gt;maxKeys &gt;&gt; 1;
00645 
00646         <span class="keywordflow">if</span> ( node-&gt;count() &gt;= minimal )
00647         {
00648                 <span class="comment">// Node is balanced</span>
00649                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00650         }
00651 
00652         NodeType *parent = 0;
00653         <span class="keywordflow">if</span> ( !loadNode( &amp;parent, node-&gt;parent_ ) )
00654         {
00655                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00656         }
00657 
00658         NodeType *leftNode = 0, *rightNode = 0;
00659         NodeType *combinedNode = 0;
00660 
00661         <span class="keywordflow">if</span> ( 0 == parentIndex - 1 )
00662         {
00663                 <span class="keywordflow">if</span> ( !loadNode( &amp;leftNode, parent-&gt;less_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00664         }
00665         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( parentIndex &gt;= 2 )
00666         {
00667                 <span class="keywordflow">if</span> ( !loadNode( &amp;leftNode, parent-&gt;elems_[ parentIndex - 2 ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00668         }
00669 
00670         <span class="keywordflow">if</span> ( parent &amp;&amp; parentIndex &lt; parent-&gt;count() )
00671         {
00672                 <span class="keywordflow">if</span> ( !loadNode( &amp;rightNode, parent-&gt;elems_[ parentIndex ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00673         }
00674 
00675         <span class="keywordflow">if</span> ( leftNode &amp;&amp; leftNode-&gt;count() &gt; minimal )
00676         {
00677                 <span class="comment">// Check left</span>
00678                 <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> parentElem = parent-&gt;elems_[ parentIndex - 1 ];
00679                 parentElem.<a class="code" href="classBTreeElement.html#o2">link_</a> = node-&gt;less_;
00680                 node-&gt;less_ = leftNode-&gt;elems_[ leftNode-&gt;count() - 1 ].link_;
00681                 node-&gt;add( parentElem );
00682                 node-&gt;flags_ = NodeType::NodeChanged;
00683 
00684                 <span class="keywordflow">if</span> ( node-&gt;less_ )
00685                 {
00686                         NodeType *less = 0;
00687                         <span class="keywordflow">if</span> ( !loadNode( &amp;less, node-&gt;less_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00688                         less-&gt;parent_ = node-&gt;addr_;
00689                         less-&gt;flags_ = NodeType::NodeChanged;
00690                 }
00691 
00692                 <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> largest;
00693                 leftNode-&gt;removeAt( leftNode-&gt;count() - 1, largest );
00694                 parent-&gt;elems_[ parentIndex - 1 ].key_ = largest.<a class="code" href="classBTreeElement.html#o0">key_</a>;
00695                 parent-&gt;elems_[ parentIndex - 1 ].data_ = largest.<a class="code" href="classBTreeElement.html#o1">data_</a>;
00696                 parent-&gt;flags_ = NodeType::NodeChanged;
00697         }
00698         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( rightNode &amp;&amp; rightNode-&gt;count() &gt; minimal )
00699         {
00700                 <span class="comment">// Check right</span>
00701                 <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> parentElem = parent-&gt;elems_[ parentIndex ];
00702                 parentElem.<a class="code" href="classBTreeElement.html#o2">link_</a> = rightNode-&gt;less_;
00703                 node-&gt;add( parentElem );
00704 
00705                 <span class="keywordflow">if</span> ( rightNode-&gt;less_ )
00706                 {
00707                         NodeType *less = 0;
00708                         <span class="keywordflow">if</span> ( !loadNode( &amp;less, rightNode-&gt;less_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00709                         less-&gt;parent_ = node-&gt;addr_;
00710                         less-&gt;flags_ = NodeType::NodeChanged;
00711                 }
00712 
00713                 <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> smallest;
00714                 rightNode-&gt;removeAt( 0, smallest );
00715                 rightNode-&gt;less_ = smallest.<a class="code" href="classBTreeElement.html#o2">link_</a>;
00716                 parent-&gt;elems_[ parentIndex ].key_ = smallest.<a class="code" href="classBTreeElement.html#o0">key_</a>;
00717                 parent-&gt;elems_[ parentIndex ].data_ = smallest.<a class="code" href="classBTreeElement.html#o1">data_</a>;
00718                 parent-&gt;flags_ = NodeType::NodeChanged;
00719         }
00720         <span class="keywordflow">else</span>
00721         {
00722                 <span class="comment">// Combine nodes</span>
00723                 <span class="keywordflow">if</span> ( leftNode )
00724                 {
00725                         <span class="keywordtype">int</span> index = leftNode-&gt;add( parent-&gt;elems_[ parentIndex - 1 ].key_,
00726                                 parent-&gt;elems_[ parentIndex - 1 ].data_ );
00727                         leftNode-&gt;elems_[ index ].link_ = node-&gt;less_;
00728                         <span class="keywordflow">if</span> ( node-&gt;less_ )
00729                         {
00730                                 NodeType *less = 0;
00731                                 <span class="keywordflow">if</span> ( !loadNode( &amp;less, node-&gt;less_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00732                                 less-&gt;parent_ = leftNode-&gt;addr_;
00733                                 less-&gt;flags_ = NodeType::NodeChanged;
00734                         }
00735 
00736                         <span class="keywordflow">if</span> ( !combine( leftNode, node ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00737                         combinedNode = leftNode;
00738                         parent-&gt;removeAt( parentIndex - 1 );
00739                 }
00740                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( rightNode )
00741                 {
00742                         <span class="keywordtype">int</span> index = node-&gt;add( parent-&gt;elems_[ parentIndex ].key_,
00743                                 parent-&gt;elems_[ parentIndex ].data_ );
00744                         node-&gt;elems_[ index ].link_ = rightNode-&gt;less_;
00745 
00746                         <span class="keywordflow">if</span> ( rightNode-&gt;less_ )
00747                         {
00748                                 NodeType *less = 0;
00749                                 <span class="keywordflow">if</span> ( !loadNode( &amp;less, rightNode-&gt;less_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00750                                 less-&gt;parent_ = node-&gt;addr_;
00751                                 less-&gt;flags_ = NodeType::NodeChanged;
00752                         }
00753 
00754                         <span class="keywordflow">if</span> ( !combine( node, rightNode ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00755                         combinedNode = node;
00756                         parent-&gt;removeAt( parentIndex );
00757                 }
00758 
00759                 parentIndex = -1;
00760 
00761                 <span class="keywordflow">if</span> ( parent &amp;&amp; parent-&gt;parent_ )
00762                 {
00763                         <span class="comment">// Find parent index</span>
00764                         NodeType *pp = 0;
00765                         <span class="keywordflow">if</span> ( !loadNode( &amp;pp, parent-&gt;parent_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00766 
00767                         <span class="keywordflow">if</span> ( pp-&gt;less_ == parent-&gt;addr_ )
00768                         {
00769                                 parentIndex = 0;
00770                         }
00771                         <span class="keywordflow">else</span>
00772                         {
00773                                 <span class="comment">// Check parents parent</span>
00774                                 <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; pp-&gt;count(); i++ )
00775                                 {
00776                                         <span class="keywordflow">if</span> ( pp-&gt;elems_[ i ].link_ == parent-&gt;addr_ )
00777                                         {
00778                                                 parentIndex = i + 1;
00779                                                 <span class="keywordflow">break</span>;
00780                                         }
00781                                 }
00782                         }
00783 
00784                         <span class="keywordflow">if</span> ( parentIndex &gt;= 0 )
00785                         {
00786                                 <span class="keywordflow">if</span> ( !rebalance( parent, parentIndex ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00787                         }
00788                 }
00789                 <span class="keywordflow">else</span>
00790                 {
00791                         <span class="comment">// It is root</span>
00792                         <span class="keywordflow">if</span> ( parent &amp;&amp; parent-&gt;isEmpty() )
00793                         {
00794                                 deleteNode( root_ );
00795                                 root_ = combinedNode;
00796                                 rootAddr( root_-&gt;addr_ );
00797                                 combinedNode-&gt;parent_ = 0;
00798                                 combinedNode-&gt;flags_ = NodeType::NodeChanged;
00799                         }
00800                 }
00801         }
00802 
00803         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00804 }
00805 
00806 <span class="comment">//      ===================================================================</span>
00807 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::combine</span>
00808 
00809 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00810 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00811 <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::combine</a>( NodeType *leftNode, 
00812                                                                                                         NodeType *rightNode )
00813 {
00814         <span class="keywordflow">if</span> ( leftNode-&gt;count() + rightNode-&gt;count() &gt; leftNode-&gt;maxKeys )
00815         {
00816                 <span class="comment">// No space for combining</span>
00817                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00818         }
00819 
00820         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; rightNode-&gt;count(); i++ )
00821         {
00822                 leftNode-&gt;elems_[ leftNode-&gt;count() ] = rightNode-&gt;elems_[ i ];
00823 
00824                 <span class="keywordflow">if</span> ( rightNode-&gt;elems_[ i ].link_ )
00825                 {
00826                         NodeType *link = 0;
00827                         <span class="keywordflow">if</span> ( !loadNode( &amp;link, rightNode-&gt;elems_[ i ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00828                         link-&gt;parent_ = leftNode-&gt;addr_;
00829                         link-&gt;flags_ = NodeType::NodeChanged;
00830                 }
00831 
00832                 leftNode-&gt;size_++;
00833                 leftNode-&gt;flags_ = NodeType::NodeChanged;
00834         }
00835 
00836         deleteNode( rightNode );
00837         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00838 }
00839 
00840 <span class="comment">//      ===================================================================</span>
00841 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::pullOut</span>
00842 
00843 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00844 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00845 <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::pullOut</a>( NodeType *node, 
00846                                                                                                                                         <span class="keywordtype">int</span> itemIndex )
00847 {
00848         NodeType *leftSubtree = 0, *rightSubtree = 0;
00849 
00850         <span class="comment">// Get subtrees</span>
00851         <span class="keywordflow">if</span> ( 0 == itemIndex )
00852         {
00853                 <span class="keywordflow">if</span> ( !loadNode( &amp;leftSubtree, node-&gt;less_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00854         }
00855         <span class="keywordflow">else</span>
00856         {
00857                 <span class="keywordflow">if</span> ( !loadNode( &amp;leftSubtree, node-&gt;elems_[ itemIndex - 1 ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00858         }
00859 
00860         <span class="keywordflow">if</span> ( !loadNode( &amp;rightSubtree, node-&gt;elems_[ itemIndex ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00861         <span class="keywordflow">if</span> ( !leftSubtree || !rightSubtree ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00862 
00863         <span class="keywordflow">if</span> ( leftSubtree-&gt;count() &gt; rightSubtree-&gt;count() )
00864         {
00865                 <span class="comment">// Left subtree is greater</span>
00866                 <span class="keywordflow">if</span> ( leftSubtree-&gt;hasChilds() )
00867                 {
00868                         KeyT largestKey;
00869                         DataT largestData;
00870                         NodeType *largestNode = rightMost( leftSubtree, largestKey, largestData );
00871                         node-&gt;elems_[ itemIndex ].key_ = largestKey;
00872                         node-&gt;elems_[ itemIndex ].data_ = largestData;
00873                         node-&gt;flags_ = NodeType::NodeChanged;
00874                         largestNode-&gt;removeAt( largestNode-&gt;count() - 1 );
00875 
00876                         NodeType *largestParent = 0;
00877                         <span class="keywordflow">if</span> ( !loadNode( &amp;largestParent, largestNode-&gt;parent_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00878                         <span class="keywordflow">if</span> ( !rebalance( largestNode, largestParent-&gt;count() ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00879                 }
00880                 <span class="keywordflow">else</span>
00881                 {
00882                         node-&gt;elems_[ itemIndex ].key_ = leftSubtree-&gt;elems_[ leftSubtree-&gt;count() - 1 ].key_;
00883                         node-&gt;elems_[ itemIndex ].data_ = leftSubtree-&gt;elems_[ leftSubtree-&gt;count() - 1 ].data_;
00884                         node-&gt;flags_ = NodeType::NodeChanged;
00885                         leftSubtree-&gt;removeAt( leftSubtree-&gt;count() - 1 );
00886                         <span class="keywordflow">if</span> ( !rebalance( leftSubtree, itemIndex ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00887                 }
00888         }
00889         <span class="keywordflow">else</span>
00890         {
00891                 <span class="comment">// Right subtree is greater</span>
00892                 <span class="keywordflow">if</span> ( rightSubtree-&gt;hasChilds() )
00893                 {
00894                         KeyT smallestKey;
00895                         DataT smallestData;
00896                         NodeType *smallestNode = leftMost( rightSubtree, smallestKey, smallestData );
00897                         node-&gt;elems_[ itemIndex ].key_ = smallestKey;
00898                         node-&gt;elems_[ itemIndex ].data_ = smallestData;
00899                         node-&gt;flags_ = NodeType::NodeChanged;
00900                         smallestNode-&gt;removeAt( 0 );
00901                         <span class="keywordflow">if</span> ( !rebalance( smallestNode, 0 ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00902                 }
00903                 <span class="keywordflow">else</span>
00904                 {
00905                         node-&gt;elems_[ itemIndex ].key_ = rightSubtree-&gt;elems_[ 0 ].key_;
00906                         node-&gt;elems_[ itemIndex ].data_ = rightSubtree-&gt;elems_[ 0 ].data_;
00907                         node-&gt;flags_ = NodeType::NodeChanged;
00908                         rightSubtree-&gt;removeAt( 0 );
00909                         <span class="keywordflow">if</span> ( !rebalance( rightSubtree, itemIndex + 1 ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00910                 }
00911         }
00912 
00913         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00914 }
00915 
00916 <span class="comment">//      ===================================================================</span>
00917 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::rightMost</span>
00918 
00919 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00920 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00921 <span class="keyword">typename</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;</a>::NodeType* 
00922                 <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::rightMost</a>( NodeType *subtree, 
00923                                                                                                 KeyT &amp;largestKey, DataT &amp;largestData )
00924 {
00925         <span class="keywordflow">if</span> ( subtree-&gt;elems_[ subtree-&gt;count() - 1 ].link_ )
00926         {
00927                 NodeType *rightMostLink = 0;
00928                 <span class="keywordflow">if</span> ( !loadNode( &amp;rightMostLink, subtree-&gt;elems_[ subtree-&gt;count() - 1 ].link_ ) )
00929                 {
00930                         <span class="keywordflow">return</span> 0;
00931                 }
00932 
00933                 <span class="keywordflow">return</span> rightMost( rightMostLink, largestKey, largestData );
00934         }
00935         <span class="keywordflow">else</span>
00936         {
00937                 largestKey = subtree-&gt;elems_[ subtree-&gt;count() - 1 ].key_;
00938                 largestData = subtree-&gt;elems_[ subtree-&gt;count() - 1 ].data_;
00939                 <span class="keywordflow">return</span> subtree;
00940         }
00941 }
00942 
00943 <span class="comment">//      ===================================================================</span>
00944 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::leftMost</span>
00945 
00946 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00947 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00948 <span class="keyword">typename</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;</a>::NodeType* 
00949                         <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::</a>
00950 <a class="code" href="classBTreeAlgorithms.html">			leftMost</a>( NodeType *subtree, KeyT &amp;smallestKey, DataT &amp;smallestData )
00951 {
00952         <span class="keywordflow">if</span> ( subtree-&gt;less_ )
00953         {
00954                 NodeType *leftMostLink = 0;
00955                 <span class="keywordflow">if</span> ( !loadNode( &amp;leftMostLink, subtree-&gt;less_ ) )
00956                 {
00957                         <span class="keywordflow">return</span> 0;
00958                 }
00959 
00960                 <span class="keywordflow">return</span> leftMost( leftMostLink, smallestKey, smallestData );
00961         }
00962         <span class="keywordflow">else</span>
00963         {
00964                 smallestKey = subtree-&gt;elems_[ 0 ].key_;
00965                 smallestData = subtree-&gt;elems_[ 0 ].data_;
00966                 <span class="keywordflow">return</span> subtree;
00967         }
00968 }
00969 
00970 <span class="comment">//      ===================================================================</span>
00971 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::splitNode</span>
00972 
00973 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
00974 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
00975 <span class="keywordtype">bool</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::splitNode</a>( NodeType *node, 
00976                                                 <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> &amp;median, NodeType **nodeRight )
00977 {
00978         <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> insertElem( median );
00979         <span class="keywordtype">int</span> medianIndex = getMedian( node, median );
00980 
00981         NodeType nodeLeftTmp;
00982         *nodeRight = newNode();
00983 
00984         <span class="comment">// Replace element</span>
00985         node-&gt;removeAt( medianIndex );
00986         node-&gt;add( insertElem );
00987 
00988         ( *nodeRight )-&gt;less_ = median.<a class="code" href="classBTreeElement.html#o2">link_</a>;
00989         <span class="keywordflow">if</span> ( median.<a class="code" href="classBTreeElement.html#o2">link_</a> )
00990         {
00991                 NodeType *link = 0;
00992                 <span class="keywordflow">if</span> ( !loadNode( &amp;link, median.<a class="code" href="classBTreeElement.html#o2">link_</a> ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00993                 link-&gt;parent_ = ( *nodeRight )-&gt;addr_;
00994                 link-&gt;flags_ = NodeType::NodeChanged;
00995         }
00996         nodeLeftTmp.less_ = node-&gt;less_;
00997 
00998         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; node-&gt;size_; i++ )
00999         {
01000                 <span class="keywordflow">if</span> ( node-&gt;elems_[ i ].key_ &lt; median.<a class="code" href="classBTreeElement.html#o0">key_</a> )
01001                 {
01002                         nodeLeftTmp.elems_[ nodeLeftTmp.size_ ] = node-&gt;elems_[ i ];
01003                         nodeLeftTmp.size_++;
01004                 }
01005                 <span class="keywordflow">else</span>
01006                 {
01007                         ( *nodeRight )-&gt;elems_[ ( *nodeRight )-&gt;size_ ] = node-&gt;elems_[ i ];
01008 
01009                         <span class="keywordflow">if</span> ( node-&gt;elems_[ i ].link_ )
01010                         {
01011                                 NodeType *link = 0;
01012                                 
01013                                 <span class="keywordtype">bool</span> wasInCache = nodeInCache( node-&gt;elems_[ i ].link_ );
01014                                 <span class="keywordflow">if</span> ( !loadNode( &amp;link, node-&gt;elems_[ i ].link_ ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
01015                                 link-&gt;parent_ = ( *nodeRight )-&gt;addr_;
01016                                 link-&gt;flags_ = NodeType::NodeChanged;
01017                                 <span class="keywordflow">if</span> ( link &amp;&amp; !wasInCache ) releaseNode( link-&gt;addr_ );
01018                         }
01019 
01020                         ( *nodeRight )-&gt;size_++;
01021                 }
01022         }
01023 
01024         <span class="comment">// Prepare result</span>
01025         ( *nodeRight )-&gt;parent_ = node-&gt;parent_;
01026         nodeLeftTmp.parent_ = node-&gt;parent_;
01027         nodeLeftTmp.addr_ = node-&gt;addr_;
01028         *node = nodeLeftTmp;
01029 
01030         ( *nodeRight )-&gt;flags_ = NodeType::NodeChanged;
01031         node-&gt;flags_ = NodeType::NodeChanged;
01032 
01033         median.<a class="code" href="classBTreeElement.html#o2">link_</a> = ( *nodeRight )-&gt;addr_;
01034         <span class="keywordflow">return</span> <span class="keyword">true</span>;
01035 }
01036 
01037 <span class="comment">//      ===================================================================</span>
01038 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::getMedian</span>
01039 
01040 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
01041 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
01042 <span class="keywordtype">int</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::getMedian</a>( 
01043         <a class="code" href="classBTreeNode.html">BTreeNode&lt; NodeSize, KeyT, DataT &gt;</a> *node, 
01044         <a class="code" href="classBTreeElement.html">BTreeElement&lt; KeyT, DataT &gt;</a> &amp;elem )
01045 {
01046         <span class="keywordtype">int</span> medianRange = node-&gt;<a class="code" href="classBTreeNode.html#o3">size_</a> &gt;&gt; 1;
01047         elem = node-&gt;<a class="code" href="classBTreeNode.html#o2">elems_</a>[ medianRange ];
01048         <span class="keywordflow">return</span> medianRange;
01049 }
01050 
01051 <span class="comment">//      ===================================================================</span>
01052 <span class="comment">//      BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::findNode</span>
01053 
01054 <span class="keyword">template</span>&lt; <span class="keywordtype">int</span> NodeSize, <span class="keyword">typename</span> KeyT, <span class="keyword">typename</span> DataT, 
01055 <span class="keyword">template</span> &lt; <span class="keywordtype">int</span>, <span class="keyword">typename</span>, <span class="keyword">typename</span> &gt; <span class="keyword">class </span>TController &gt;
01056 <span class="keyword">typename</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;</a>::NodeType* 
01057                 <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; NodeSize, KeyT, DataT, TController &gt;::</a>
01058 <a class="code" href="classBTreeAlgorithms.html">		findNode</a>( NodeType *node, <span class="keyword">const</span> KeyT &amp;key, <span class="keywordtype">int</span> &amp;retIndex, <span class="keywordtype">int</span> &amp;parentIndex, <span class="keywordtype">bool</span> &amp;found )
01059 {
01060         <span class="keywordflow">if</span> ( !node ) <span class="keywordflow">return</span> 0;
01061 
01062         found = <span class="keyword">false</span>;
01063         retIndex = -1;
01064 
01065         <span class="keywordflow">if</span> ( node-&gt;find( key, retIndex ) )
01066         {
01067                 <span class="comment">// Key found</span>
01068                 found = <span class="keyword">true</span>;
01069                 <span class="keywordflow">return</span> node;
01070         }
01071 
01072         <span class="keywordtype">int</span> link = 0;
01073 
01074         <span class="keywordflow">if</span> ( retIndex &gt; 0 )
01075         {
01076                 link = node-&gt;elems_[ retIndex - 1 ].link_;
01077         }
01078         <span class="keywordflow">else</span>
01079         {
01080                 link = node-&gt;less_;
01081         }
01082 
01083         <span class="keywordflow">if</span> ( !link )
01084         {
01085                 <span class="comment">// No more kids</span>
01086                 <span class="keywordflow">return</span> node;
01087         }
01088         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( link == node-&gt;addr_ )
01089         {
01090                 <span class="comment">// Simple cyclic traversal skip (in case of corrapted index)</span>
01091                 <span class="keywordflow">return</span> 0;
01092         }
01093 
01094         NodeType *nextLink = 0;
01095         <span class="keywordflow">if</span> ( !loadNode( &amp;nextLink, link ) ) <span class="keywordflow">return</span> 0;
01096 
01097         parentIndex = retIndex;
01098         <span class="keywordflow">return</span> findNode( nextLink, key, retIndex, parentIndex, found );
01099 }
01100 
01101 <span class="preprocessor">#endif // __BTreeAlgorithms_h__</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 18 11:38:49 2007 for EmbeddedFileSystem by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
