<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>EmbeddedFileSystem: Efs.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a></div>
<h1>Efs.h</h1><div class="fragment"><pre>00001 
00002 
00003 
00004 
00005 
00006 
00007 
00008 <span class="preprocessor">#ifndef __Efs_h__</span>
00009 <span class="preprocessor"></span><span class="preprocessor">#define __Efs_h__</span>
00010 <span class="preprocessor"></span>
00011 <span class="preprocessor">#include "EfsConfig.h"</span>
00012 <span class="preprocessor">#include "EfsDefs.h"</span>
00013 <span class="preprocessor">#include "EfsFile.h"</span>
00014 <span class="preprocessor">#include "FreesBTree.h"</span>
00015 <span class="preprocessor">#include "JFileStream.h"</span>
00016 
00020 
<a name="l00021"></a><a class="code" href="classEfs.html">00021</a> <span class="keyword">class </span><a class="code" href="classEfs.html">Efs</a>
00022 {
00023 <span class="keyword">public</span>:
00024 
00025         <a class="code" href="classEfs.html">Efs</a>();
00026         ~<a class="code" href="classEfs.html">Efs</a>();
00027 
00030         <span class="keywordtype">bool</span> <a class="code" href="classEfs.html#a2">mount</a>( <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *<a class="code" href="classEfs.html#a31">path</a> );
00031 
00034         <span class="keywordtype">void</span> <a class="code" href="classEfs.html#a3">umount</a>();
00035 
00039         <span class="keywordtype">int</span> <a class="code" href="classEfs.html#a4">createFile</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> fileAccess, <span class="keywordtype">int</span> createDisp );
00040 
00043         <span class="keywordtype">bool</span> <a class="code" href="classEfs.html#a5">deleteFile</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *name );
00044 
00047         <span class="keywordtype">void</span> <a class="code" href="classEfs.html#a6">closeFile</a>( <span class="keywordtype">int</span> fd );
00048 
00049         <span class="comment">// Change file info</span>
00050         gint64 seekFile( <span class="keywordtype">int</span> fd, gint64 newPos );
00051         <span class="keywordtype">bool</span> rename( <span class="keyword">const</span> <span class="keywordtype">char</span>* oldName, <span class="keyword">const</span> <span class="keywordtype">char</span> *newName );
00052         <span class="keywordtype">bool</span> changeFileAttrs( <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> newAttrs );
00053 
00054         <span class="comment">// File info</span>
00055         <span class="keywordtype">bool</span> isExists( <span class="keyword">const</span> <span class="keywordtype">char</span> *name ) <span class="keyword">const</span>;
00056         <span class="keywordtype">bool</span> atEnd( <span class="keywordtype">int</span> fd ) <span class="keyword">const</span>;
00057         gint64 filePos( <span class="keywordtype">int</span> fd ) <span class="keyword">const</span>;
00058         gint64 fileSize( <span class="keywordtype">int</span> fd ) <span class="keyword">const</span>;
00059         <span class="keywordtype">bool</span> queryFileInfo( <span class="keywordtype">int</span> fd, EfsFileInfo &amp;fileInfo ) <span class="keyword">const</span>;
00060         <span class="keywordtype">int</span> fileAttrs( <span class="keywordtype">int</span> fd ) <span class="keyword">const</span>;
00061         <span class="keywordtype">void</span> listFiles( EfsFilenameList &amp;retList );
00062 
00063         <span class="comment">// File system info</span>
00064         gint64 size() <span class="keyword">const</span>;
00065         <span class="keywordtype">void</span> info( EfsInfoStruct &amp;info );
00066         <span class="keywordtype">float</span> fragDegree();
00067         <span class="keywordtype">int</span> version() <span class="keyword">const</span>;
00068 
00069         <span class="comment">// File operations</span>
00070         <span class="keywordtype">bool</span> resize( <span class="keywordtype">int</span> fd, gint64 newSize );
00071 
00072         <span class="keywordtype">bool</span> writeFile( <span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> bufSize );
00073         <span class="keywordtype">int</span> readFile( <span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> bufSize );
00074 
00075         <span class="comment">// Adaptive File System error code return</span>
00076         EfsErrorCode lastErrorCode() <span class="keyword">const</span>;
00077 
00080         <span class="keywordtype">void</span> <a class="code" href="classEfs.html#a25">setGrowthFactor</a>( gint64 factor );
00081 
00084         <span class="keywordtype">void</span> <a class="code" href="classEfs.html#a26">setCallback</a>( <a class="code" href="classEfsCallback.html">EfsCallback</a> *cback );
00085 
00088         <span class="keywordtype">bool</span> <a class="code" href="classEfs.html#a27">defrag</a>();
00089 
00090         <span class="comment">// Set and get general overhead information</span>
00091         <span class="keywordtype">void</span> setOverheadInfo( <span class="keyword">const</span> EfsOverhead &amp;general );
00092         <span class="keywordtype">void</span> getOverheadInfo( EfsOverhead &amp;general ) <span class="keyword">const</span>;
00093 
00097         <span class="keywordtype">bool</span> <a class="code" href="classEfs.html#a30">recreate</a>();
00098 
00101         QString <a class="code" href="classEfs.html#a31">path</a>() <span class="keyword">const</span>;
00102 
00105         <span class="keywordtype">void</span> <a class="code" href="classEfs.html#a32">setEncryptor</a>( <a class="code" href="classEfsEncryptor.html">EfsEncryptor</a> *encryptor );
00106 
00109         <a class="code" href="classEfsEncryptor.html">EfsEncryptor</a>* <a class="code" href="classEfs.html#a33">getEncryptor</a>();
00110 
00111 <span class="preprocessor">#if AFS_DEBUG</span>
00112 <span class="preprocessor"></span>        <span class="keywordtype">void</span> debugWrite();
00113 <span class="preprocessor">#endif // AFS_DEBUG</span>
00114 <span class="preprocessor"></span>
00115 <span class="keyword">protected</span>: <span class="comment">// Methods</span>
00116 
00117         <span class="keywordtype">bool</span> getMaxFreeChunk( EfsFragment &amp;chunk );
00118         <span class="keywordtype">bool</span> getMinFreeChunk( EfsFragment &amp;chunk, <span class="keywordtype">int</span> size );
00119 
00120         <span class="keywordtype">bool</span> growFS();
00121 
00122         <span class="keywordtype">int</span> allocateSpace( EfsFragment &amp;chunk, <span class="keyword">const</span> EfsFragment &amp;need );
00123         <span class="keywordtype">bool</span> smartAllocate( <span class="keywordtype">int</span> preferAddr, <span class="keywordtype">int</span> needBlocks, 
00124                 EfsAllocMethod allocMethod, EfsFragmentList &amp;retList );
00125 
00126         <span class="keywordtype">void</span> removeFreeSpace( <span class="keywordtype">int</span> blockAddr, <span class="keywordtype">int</span> blockCount );
00127         <span class="keywordtype">void</span> deallocateSpace( <span class="keywordtype">int</span> blockAddr, <span class="keywordtype">int</span> blockCount );
00128         <span class="keywordtype">void</span> deallocateLiberalSpace( EfsFitCache::iterator &amp;iter );
00129 
00130         <span class="keywordtype">bool</span> makeRoom( EfsFitCache::iterator &amp;iter, gint64 newSize );
00131         <span class="keywordtype">bool</span> <a class="code" href="classEfs.html#b9">ensureSpace</a>( <span class="keywordtype">int</span> blocks );
00132 
00133         <span class="keywordtype">int</span> findFile( <span class="keyword">const</span> <span class="keywordtype">char</span> *name ) <span class="keyword">const</span>;
00134 
00135         <span class="comment">// Block read/write logic</span>
00136         <span class="keywordtype">bool</span> readBlock( <span class="keywordtype">int</span> blockAddr, <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> bufSize, <span class="keywordtype">int</span> blockOffset );
00137         <span class="keywordtype">bool</span> writeBlock( <span class="keywordtype">int</span> blockAddr, <span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> bufSize, 
00138                 <span class="keywordtype">int</span> blockOffset, <span class="keywordtype">bool</span> appendData );
00139 
00140         <span class="keywordtype">bool</span> readFit( <span class="keywordtype">int</span> addr, <a class="code" href="classEfsFit.html">EfsFit</a> &amp;entry );
00141         <span class="keywordtype">bool</span> writeFit( <span class="keywordtype">int</span> addr, <span class="keyword">const</span> <a class="code" href="classEfsFit.html">EfsFit</a> &amp;entry, <span class="keywordtype">bool</span> checkSi = <span class="keyword">false</span> );
00142 
00143         <span class="keywordtype">void</span> verifyFSStructure();
00144         <span class="keywordtype">void</span> removeFromFreeSpaceMap( EfsFragment &amp;chunk );
00145 
00146         <span class="keywordtype">void</span> deleteFileOS( <span class="keyword">const</span> QString &amp;path );
00147         <span class="keywordtype">void</span> renameFileOS( <span class="keyword">const</span> QString &amp;from, <span class="keyword">const</span> QString &amp;to );
00148 
00149 <span class="keyword">protected</span>: <span class="comment">// Data members</span>
00150 
00151         <span class="keyword">friend</span> <span class="keyword">class </span>EfsBTreeController&lt; EfsTreeNameNodeSize, EfsNameKey, int &gt;;
00152         <span class="keyword">friend</span> <span class="keyword">class </span>EfsBTreeController&lt; EfsTreePtrNodeSize, int, int &gt;;
00153 
00154         QString path_;
00155         <a class="code" href="classEfsFile.html">EfsFile</a> *fs_;
00156 
00157         <span class="keyword">typedef</span> <a class="code" href="classBTreeAlgorithms.html">BTreeAlgorithms&lt; EfsTreeNameNodeSize, EfsNameKey, int, EfsBTreeController &gt;</a> <a class="code" href="classBTreeAlgorithms.html">FitsBTreeType</a>;
00158 
00159         <span class="keyword">mutable</span> <a class="code" href="classBTreeAlgorithms.html">FitsBTreeType</a> fits_;
00160         FreeSizesMap freeSizes_;
00161         FreePtrsMap freeMemPtrs_;
00162         <a class="code" href="classFreesBTree.html">FreesBTree</a> freePtrs_;
00163 
00164         <span class="comment">// Cache of opened fits</span>
00165         EfsFitCache fitCache_;
00166 
00167         <span class="comment">// Opened files</span>
00168         EfsHandleMap handles_;
00169         <span class="keywordtype">int</span> handleCntr_;
00170         EfsOverhead overhead_;
00171 
00172         <span class="keyword">mutable</span> EfsErrorCode lastErrorCode_;
00173         <a class="code" href="classEfsCallback.html">EfsCallback</a> *callback_;
00174         <a class="code" href="classEfsEncryptor.html">EfsEncryptor</a> *encryptor_;
00175 
00176         <span class="keywordtype">int</span> ver_;
00177 
00178         <span class="comment">// Buffers</span>
00179         <span class="keywordtype">char</span> readBuffer_[ EfsDefaultBlockSize + 1 ];
00180         <span class="keywordtype">int</span> readBufAddr_;
00181 
00182         <span class="comment">// Multithread support</span>
00183         AFS_MULTITHREAD_SUPPORT;
00184 
00185 <span class="keyword">private</span>:
00186 
00187         <span class="comment">// Don't permit copy file systems</span>
00188         <a class="code" href="classEfs.html">Efs</a>( <span class="keyword">const</span> <a class="code" href="classEfs.html">Efs</a> &amp;copy );
00189         <a class="code" href="classEfs.html">Efs</a>&amp; operator=( <span class="keyword">const</span> <a class="code" href="classEfs.html">Efs</a> &amp;rv );
00190 
00191 };
00192 
00193 <span class="preprocessor">#endif // __Efs_h__</span>
00194 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Oct 18 11:38:49 2007 for EmbeddedFileSystem by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
